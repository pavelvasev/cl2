Макросы-трансформеры.

Потребности:
- реализовать if xxx then xxx else xxx
- реализовать лаконичное обозначение что процесс может строить древовидные структуры.

Решение.

подумалось что-то вроде декораторов, например

%mixin "source1" 
%mixin "source2"
obj "name" { .... }

или

%tree
obj "name" { .... }

------
Насчет декораторов Миша проговорил что внутри - как-то понятнее

obj "name" {
	%tree
	%mixin "other"
}

и т.д. и т.п. и это даже красиво. но это не сработает для функций например, а для них нам бы тоже хотелось декораторы.

======
Варианты решения
- для if можно было бы сделать особую форму на уровне парсера pegjs и не мучиться. т.к. для пайп например сделали же.

	но вдруг еще захочется.. for там какой-нибудь.. или return например кстати вполне мог бы возвращать просто следующий объект...

- для декораторов можно было бы просто отлавливать записи вида %name и класть его в атрибут decorators у obj и func, а дальше они там сами пусть.	

Решение 2
- давно была идея что делать транслятору 2 прогона.
1 преобразующий 2 кодогенерирующий
и преоразующий меняет узлы, а кодогенерирующий генерирует как обычно.

причем менять узлы надо так чтобы не только текущий узел смотреть а и следующий например.

ну в итоге приходит идея обобщения что пусть вообще весь список смотрит а мы идем по нему по очереди, и вызываем подходящие трансформеры-макросы и передаем весь список и номер элемента. а эта штука должна вернуть.. новое значение всего списка ну и счетчик уж заодно кстати.

а то мало ли она там удалит то что до нее было - надо и счетчик тогда сдвигать. (удалить до нее - это например xxx if yyyy - тут if по идее удалит)

---------------
о названиях. Как назвать варианты
- декоратор, но декоратор по идее в рантайме обычно работает
- траснформер, подходит но долго ну и обобщение какое-то.. у нас так-то все трансформером является.. любые вычисления...
да и трансы.. зачем это..
- макрос, мило но непонятно. но мило.
  с ним засада что по анлгийски надо писать macro
  а по русски звучит "макрос"
  да и название так-то дебильное (вот ребенку такое объясни.. слово..)
- helper, convertor.. ?
- генератор?
  но он занят в js и питон это другое
- хобот! trunk.. )))
  trunk "if", trunk "mixin"
  но оно как панк..
  кстати идея - максимально коротко..
  а если ma? не вашим не нашим )))
  ma "mixin" {

  }
  это даже троллинг такой ))))

- сахар, штамп, желудь, дескриптор  

надо как-то назвать а там видно будет. ну пусть макрос будет, нам не жалко. ну засада с языком, ну внимание будет включать.

update - по опросу населения слово макрос это глупое слово и непонятно с чем ассоциируется.
поэтому трансформ.

---------------

итого реализация в macros.cl и оно дефолтом пусть подгружается.

F-MACRO F-TRANSFORM

transform "tree" {: i objs state C |
  ... тут как угодно меняем objs
  return {i,objs}
:}

а ну и еще - эти макросы делают понятие "формы" ненужным.
ну потому что форма это частный вид макроса, такой простой который вместо себя подставляет paste-вызов..

----